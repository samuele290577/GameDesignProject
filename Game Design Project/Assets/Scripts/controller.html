
<html>
<head>

  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.7.0.js"></script>
  
  <link rel="stylesheet" href="style.css">
 
  <script type="text/javascript" src="touch-area.js"></script>
  <script type="text/javascript" src="rate-limiter.js"></script>

  <script type="text/javascript">
    //the view manager finds all div containers with the "view" class and lets me show one view while hiding all others
    //see also: https://github.com/AirConsole/airconsole-view-manager
    var ViewManager = {
      views: {},
      current_view_id: null,

      init: function() {
        var views = document.querySelectorAll('.view');
        for (var i = 0; i < views.length; i++) {
          this.views[views[i].id] = views[i];
        }
        return this;
      },

      show: function(id) {
        var view = this.views[id];
        if (view) {
          this.current_view_id = id;
          this.hideAll();
          view.style.display = "block";
        } else {
          console.warn("Could not find view with ID:", id);
        }
        return this;
      },

      hideAll: function() {
        for (var key in this.views) {
          this.views[key].style.display = "none";
        }
      }
    };
  </script>

   <script type="text/javascript">

    var airconsole;
    var myCardsIds;
    var cardIndex = 0;

    /**
    * Database delle cards
    */
    var cards = {
        0: {
            "id": 0,
            "name": "Apple"
        },
        1: {
            "id": 1,
            "name": "Banana"
        },
        2: {
            "id": 2,
            "name": "Pineapple"
        },
        3: {
            "id": 3,
            "name": "Coconut"
        },
        4: {
            "id": 4,
            "name": "Watermelon"
        },
        5: {
            "id": 5,
            "name": "Oranges"
        },
        6: {
            "id": 6,
            "name": "Rocks"
        },
        7: {
            "id": 7,
            "name": "Trunk"
        },
        8: {
            "id": 8,
            "name": "Quicksand"
        },
        10: {
            "id": 10,
            "name": "Bomb"
        },
        11: {
            "id": 11,
            "name": "Dynamite"
        },
        12: {
            "id": 12,
            "name": "Molotov"
        },
        13: {
            "id": 13,
            "name": "Rifle"
        },
        14: {
            "id": 14,
            "name": "Shotgun"
        },
        15: {
            "id": 15,
            "name": "Knife"
        },
        16: {
            "id": 16,
            "name": "Wall"
        },
        17: {
            "id": 17,
            "name": "Barrels"
        },
        18: {
            "id": 18,
            "name": "Mine"
        }
    }

    
    /**
     * Sets up the communication to the screen.
     */
    function App() {
      var me = this;
      me.airconsole = new AirConsole({"orientation": "portrait", "synchronize_time" : "true"});

      //initialize the view manager and set the first view
      ViewManager.init();
  	  ViewManager.show("ChooseTeam");

      me.airconsole.onMessage = function(from, data) {
        console.log("Controller ", me.airconsole.getDeviceId(), "Received: ", data);
        
        if(data["action"]!=null && data["action"]=="cards") {
            myCardsIds = data.content;
            console.log(myCardsIds);
            updateCardsView();
        }
        else if (data["action"]!=null && data["action"]=="showChooseCard") {
            ViewManager.show("ChooseCard");
        }
        else if (data["action"]!=null && data["action"]=="showWaitYourTurn") {
            ViewManager.show("WaitYourTurn");
        }
        else if(data["action"]!=null && data["action"]=="showThrowItem") {
            ViewManager.show("ThrowItem");
        }
        else if(data["action"]!=null && data["action"]=="showBuildDeck") {
            ViewManager.show("BuildDeck");
        }
        else if(data["action"]!=null && data["action"]=="showMove") {
            ViewManager.show("Move");
        }
      };
      
      var rateLimiter = new RateLimiter(me.airconsole);



      /**
      * Tutto ciò che riguarda la touch area per la FASE DI MOVIMENTO
      */
      var touch_area_move = new TouchArea("touch_area_move", {
        "touchstart": function(position) {
          var startCircle = document.getElementById("start_circle_move");
          startCircle.style.display= "block";
          startCircle.style.left = "calc(" + position.x*100 + "% - 15px";
          startCircle.style.top = "calc(" + position.y*100 + "% - 15px";
          var line = document.getElementById("line_move");
          line.setAttribute("x1", position.x*100);
          line.setAttribute("y1", position.y*100);
          rateLimiter.message(AirConsole.SCREEN, {
            "action": "touch_move_start",
            "position": position,
            "width": document.getElementById("touch_area_move").getBoundingClientRect().width,
            "height": document.getElementById("touch_area_move").getBoundingClientRect().height
          });
        },
        "touchmove": function(position) {
          var endCircle = document.getElementById("end_circle_move");
          endCircle.style.display= "block";
          endCircle.style.left = "calc(" + position.x*100 + "% - 15px";
          endCircle.style.top = "calc(" + position.y*100 + "% - 15px";
          var line = document.getElementById("line_move");
          line.setAttribute("x2", position.x*100);
          line.setAttribute("y2", position.y*100);
          document.getElementById("line_svg_move").style.display = "block";
          rateLimiter.message(AirConsole.SCREEN, {
            "action": "touch_move_move",
            "position": position,
            "width": document.getElementById("touch_area_move").getBoundingClientRect().width,
            "height": document.getElementById("touch_area_move").getBoundingClientRect().height
          });
        },
        "touchend": function(position) {
          document.getElementById("start_circle_move").style.display = "none";
          document.getElementById("end_circle_move").style.display = "none";
          document.getElementById("line_svg_move").style.display = "none";
          rateLimiter.message(AirConsole.SCREEN, {
            "action": "touch_move_end",
            "position": position,
            "width": document.getElementById("touch_area_move").getBoundingClientRect().width,
            "height": document.getElementById("touch_area_move").getBoundingClientRect().height
          });
        }
      });


      /**
      * Tutto ciò che riguarda la touch area per la FASE DI LANCIO
      */
      var touch_area_throw = new TouchArea("touch_area_throw", {
        "touchstart": function(position) {
          var startCircle = document.getElementById("start_circle_throw");
          startCircle.style.display= "block";
          startCircle.style.left = "calc(" + position.x*100 + "% - 15px";
          startCircle.style.top = "calc(" + position.y*100 + "% - 15px";
          var line = document.getElementById("line_throw");
          line.setAttribute("x1", position.x*100);
          line.setAttribute("y1", position.y*100);
          rateLimiter.message(AirConsole.SCREEN, {
            "action": "touch_throw_start",
            "position": position,
            "width": document.getElementById("touch_area_throw").getBoundingClientRect().width,
            "height": document.getElementById("touch_area_throw").getBoundingClientRect().height
          });
        },
        "touchmove": function(position) {
          var endCircle = document.getElementById("end_circle_throw");
          endCircle.style.display= "block";
          endCircle.style.left = "calc(" + position.x*100 + "% - 15px";
          endCircle.style.top = "calc(" + position.y*100 + "% - 15px";
          var line = document.getElementById("line_throw");
          line.setAttribute("x2", position.x*100);
          line.setAttribute("y2", position.y*100);
          document.getElementById("line_svg_throw").style.display = "block";
          rateLimiter.message(AirConsole.SCREEN, {
            "action": "touch_throw_move",
            "position": position,
            "width": document.getElementById("touch_area_throw").getBoundingClientRect().width,
            "height": document.getElementById("touch_area_throw").getBoundingClientRect().height
          });
        },
        "touchend": function(position) {
          document.getElementById("start_circle_throw").style.display = "none";
          document.getElementById("end_circle_throw").style.display = "none";
          document.getElementById("line_svg_throw").style.display = "none";
          rateLimiter.message(AirConsole.SCREEN, {
            "action": "touch_throw_end",
            "position": position,
            "width": document.getElementById("touch_area_throw").getBoundingClientRect().width,
            "height": document.getElementById("touch_area_throw").getBoundingClientRect().height
          });
        }
      });


      /**
       * Here we are adding support for mouse events manually.
       * WE STRONGLY ENCOURAGE YOU TO USE THE AIRCONSOLE CONTROLS LIBRARY
       * WHICH IS EVEN BETTER (BUT WE DONT WANT TO BLOAT THE CODE HERE).
       * https://github.com/AirConsole/airconsole-controls/
       * 
       * NO MATTER WHAT YOU DECIDE, DO NOT USE ONCLICK HANDLERS.
       * THEY HAVE A 200MS DELAY!
       */
      if (!("ontouchstart" in document.createElement("div"))) {
        var elements = document.getElementsByTagName("*");
        for (var i = 0; i < elements.length; ++i) {
          var element = elements[i];
          var ontouchstart = element.getAttribute("ontouchstart");
          if (ontouchstart) {
            element.setAttribute("onmousedown", ontouchstart);
          }
          var ontouchend = element.getAttribute("ontouchend");
          if (ontouchend) {
            element.setAttribute("onmouseup", ontouchend);
          }
        }
      }
    }
    
     App.prototype.sendMessageToScreen = function(msg) {
        console.log("Button Pressed");
       this.airconsole.message(AirConsole.SCREEN, msg);
    };

    function leftCard() {
        if (cardIndex==0) return;
        else {
            cardIndex--;
            updateCardsView();
        }
    }

    function rightCard() {
        if (cardIndex == myCardsIds.length-1) return;
        else {
            cardIndex++;
            updateCardsView();
        }
    }

    function updateCardsView() {
        cardIndex > 0 ? document.getElementById("before_card_content").innerHTML = cards[myCardsIds[cardIndex-1]].name : document.getElementById("before_card_content").innerHTML = "";
        document.getElementById("active_card_content").innerHTML = cards[myCardsIds[cardIndex]].name;
        cardIndex < myCardsIds.length-1 ? document.getElementById("after_card_content").innerHTML = cards[myCardsIds[cardIndex+1]].name : document.getElementById("after_card_content").innerHTML = "";
    }

    function enterCard() {
        window.app.sendMessageToScreen({"action": "confirm_card", "cardId": myCardsIds[cardIndex]});
    }

    function skipMovement() {
        window.app.sendMessageToScreen({"action": "skip_movement"});
    }
  </script>
  
 </head>











<body onload="window.app = new App()">

    <div class="view" id="ChooseTeam">
        <div class="button" id="button_plants" ontouchstart="window.app.sendMessageToScreen({'action': 'pick_plants'})">PLANTS</div>
        <div class="button" id="button_humans" ontouchstart="window.app.sendMessageToScreen({'action': 'pick_humans'})">HUMANS</div>
        <div class="button" id="button_plants" ontouchstart="window.app.sendMessageToScreen({'action': 'team_ready'})">READY</div>
        <div class="button" id="button_skip_build" ontouchstart="window.app.sendMessageToScreen({'action': 'skip_build'})">(DEV) SKIP TO EARTH</div>
    </div>

    <div class="view" id="BuildDeck">
        <div class="button" id="button_plants" ontouchstart="window.app.sendMessageToScreen({'action': 'deck_up'})">UP</div>
        <div class="button" id="button_humans" ontouchstart="window.app.sendMessageToScreen({'action': 'deck_down'})">DOWN</div>
        <div class="button" id="button_plants" ontouchstart="window.app.sendMessageToScreen({'action': 'deck_add'})">ADD</div>
        <div class="button" id="button_plants" ontouchstart="window.app.sendMessageToScreen({'action': 'deck_remove'})">REMOVE</div>
        <div class="button" id="button_plants" ontouchstart="window.app.sendMessageToScreen({'action': 'deck_gotowar'})">GO TO WAR</div>
    </div>

    <div class="view" id="WaitYourTurn">
        <p><br><br>It's not your turn!! WAIT! GET READY TO DESTROY YOUR ENEMYYYYY</p>
    </div>

    <div class="view" id="Move">
        <div id="touch_area_move">
            <div class="circle_move" id="start_circle_move"></div>
            <div class="circle_move" id="end_circle_move"></div>
            <svg preserveAspectRatio="none" viewBox="0 0 100 100" id="line_svg_move">
                <line id="line_move" x1="0" y1="0" x2="100" y2="100" stroke="green" />
            </svg>
        </div>
        <div class="button" style="position:absolute; bottom:5%" id="button_skip_movement" ontouchstart="skipMovement()">Skip movement</div>
    </div>

    <div class="view" id="ChooseCard">
        <div style="position: relative; height: 250px;">
            <div class="card card_before"><p class="card_content" id="before_card_content"></p></div>
            <div class="card card_active"><p class="card_content" id="active_card_content"></p></div>
            <div class="card card_after"><p class="card_content" id="after_card_content"></p></div>
        </div>
        <div>
            <div class="button" id="button_left" ontouchstart="leftCard()">LEFT</div>
            <div class="button" id="button_right" ontouchstart="rightCard()">RIGHT</div>
            <div class="button" id="button_confirm" ontouchstart="enterCard()">PLAY CARD</div>
        </div>
    </div>

    <div class="view" id="ThrowItem">
        <div id="touch_area_throw">
            <div class="circle_throw" id="start_circle_throw"></div>
            <div class="circle_throw" id="end_circle_throw"></div>
            <svg preserveAspectRatio="none" viewBox="0 0 100 100" id="line_svg_throw">
                <line id="line_throw" x1="0" y1="0" x2="100" y2="100" stroke="red" />
            </svg>
        </div>
    </div>

</body>





</html>